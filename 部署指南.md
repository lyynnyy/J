# 部署指南

本指南提供了将 Flask 应用部署到网络环境的几种方案。

## 📋 部署前准备

1. **确保数据库已构建**：运行 `python3 db_build.py` 生成 `demo.db`
2. **确保所有依赖已安装**：检查 `requirements.txt`
3. **确保密码已配置**：检查 `web_app.py` 中的密码设置

---

## 🚀 方案一：使用 Render（推荐，最简单）

[Render](https://render.com) 是一个对中文用户友好的 PaaS 平台，提供免费套餐。

### 步骤：

1. **注册账号**：访问 https://render.com 注册（可用 GitHub 账号）

2. **创建 Web Service**：
   - 点击 "New" → "Web Service"
   - 连接你的 GitHub 仓库（或手动上传代码）

3. **配置设置**：
   ```
   Name: agent-poc（或任意名称）
   Environment: Python 3
   Build Command: pip install -r requirements.txt
   Start Command: gunicorn web_app:app
   ```

4. **添加环境变量**（可选）：
   - `PORT`: Render 会自动设置
   - `SECRET_KEY`: 建议设置一个更安全的密钥

5. **部署**：点击 "Create Web Service"，等待部署完成

### 优点：
- ✅ 免费套餐可用
- ✅ 自动 HTTPS
- ✅ 操作简单
- ✅ 支持自动部署

---

## 🌐 方案二：使用 Railway

[Railway](https://railway.app) 是另一个简单易用的部署平台。

### 步骤：

1. **注册账号**：访问 https://railway.app

2. **创建项目**：
   - 点击 "New Project"
   - 选择 "Deploy from GitHub repo" 或 "Empty Project"

3. **配置启动命令**：
   - 在项目设置中设置 Start Command: `gunicorn web_app:app --bind 0.0.0.0:$PORT`

4. **部署**：Railway 会自动检测 Python 项目并部署

### 优点：
- ✅ 免费套餐可用
- ✅ 自动 HTTPS
- ✅ 操作简单

---

## 🖥️ 方案三：使用云服务器（阿里云/腾讯云/AWS）

适合需要更多控制权的用户。

### 步骤：

1. **购买云服务器**：
   - 选择 Linux 系统（推荐 Ubuntu 20.04+）
   - 最低配置：1核2G

2. **连接到服务器**：
   ```bash
   ssh root@your-server-ip
   ```

3. **安装依赖**：
   ```bash
   # 更新系统
   apt update && apt upgrade -y
   
   # 安装 Python 3 和 pip
   apt install python3 python3-pip -y
   
   # 安装 Nginx（反向代理）
   apt install nginx -y
   ```

4. **上传代码到服务器**：
   ```bash
   # 方式1：使用 git
   git clone your-repo-url
   cd poc_demo
   
   # 方式2：使用 scp
   scp -r ./poc_demo root@your-server-ip:/opt/
   ```

5. **安装 Python 依赖**：
   ```bash
   cd /opt/poc_demo
   pip3 install -r requirements.txt
   pip3 install gunicorn
   ```

6. **构建数据库**：
   ```bash
   python3 db_build.py
   ```

7. **使用 Gunicorn 启动应用**：
   ```bash
   # 测试运行
   gunicorn -w 4 -b 0.0.0.0:5000 web_app:app
   
   # 后台运行（使用 nohup）
   nohup gunicorn -w 4 -b 0.0.0.0:5000 web_app:app > app.log 2>&1 &
   ```

8. **配置 Nginx 反向代理**：
   
   编辑 `/etc/nginx/sites-available/default`：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;  # 替换为你的域名或IP
       
       location / {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```
   
   重启 Nginx：
   ```bash
   nginx -t  # 测试配置
   systemctl restart nginx
   ```

9. **配置系统服务（systemd）**：
   
   创建 `/etc/systemd/system/agent-poc.service`：
   ```ini
   [Unit]
   Description=Agent POC Flask App
   After=network.target
   
   [Service]
   User=root
   WorkingDirectory=/opt/poc_demo
   Environment="PATH=/usr/bin:/usr/local/bin"
   ExecStart=/usr/local/bin/gunicorn -w 4 -b 127.0.0.1:5000 web_app:app
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   ```
   
   启用并启动服务：
   ```bash
   systemctl daemon-reload
   systemctl enable agent-poc
   systemctl start agent-poc
   systemctl status agent-poc  # 查看状态
   ```

10. **配置防火墙**（如果使用云服务器）：
    ```bash
    # Ubuntu/Debian
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw enable
    ```

11. **配置域名和 HTTPS（可选，推荐）**：
    - 使用 Let's Encrypt 免费 SSL 证书
    ```bash
    apt install certbot python3-certbot-nginx -y
    certbot --nginx -d your-domain.com
    ```

### 优点：
- ✅ 完全控制
- ✅ 性能可调
- ✅ 适合生产环境

### 缺点：
- ⚠️ 需要服务器运维知识
- ⚠️ 需要自己维护服务器

---

## 🐳 方案四：使用 Docker 容器化部署

适合熟悉 Docker 的用户，可在任何支持 Docker 的平台上运行。

### 步骤：

1. **创建 Dockerfile**（见下方）

2. **构建镜像**：
   ```bash
   docker build -t agent-poc .
   ```

3. **运行容器**：
   ```bash
   docker run -d -p 5000:5000 --name agent-poc agent-poc
   ```

4. **使用 Docker Compose**（推荐）：
   
   创建 `docker-compose.yml`（见下方）
   
   ```bash
   docker-compose up -d
   ```

### 优点：
- ✅ 环境一致
- ✅ 易于迁移
- ✅ 适合容器化平台（如 Kubernetes）

---

## 📝 必要的配置文件

### 1. requirements.txt（需要添加 gunicorn）

```txt
Flask>=2.0.0
gunicorn>=20.1.0
```

### 2. Procfile（用于 Render/Railway）

```
web: gunicorn web_app:app --bind 0.0.0.0:$PORT
```

### 3. .env.example（环境变量示例）

```
SECRET_KEY=your-secret-key-here
PASSWORD=baa6261
PORT=5000
```

### 4. runtime.txt（指定 Python 版本，可选）

```
python-3.9.0
```

---

## 🔒 安全建议

1. **更改 Secret Key**：
   - 在生产环境中使用强随机密钥
   - 可以从环境变量读取：`os.environ.get('SECRET_KEY', 'default-key')`

2. **更改密码**：
   - 不要使用默认密码
   - 考虑使用环境变量或配置文件

3. **使用 HTTPS**：
   - 生产环境必须使用 HTTPS
   - 使用 Let's Encrypt 免费证书

4. **防火墙配置**：
   - 只开放必要的端口
   - 限制 SSH 访问

---

## 🐛 常见问题

### 1. 数据库文件路径问题
- **问题**：部署后找不到 `demo.db`
- **解决**：确保数据库文件在正确路径，或使用绝对路径

### 2. 端口问题
- **问题**：应用无法启动
- **解决**：检查端口是否被占用，使用 `lsof -i :5000` 查看

### 3. 静态文件404
- **问题**：CSS/JS 文件无法加载
- **解决**：检查 `static_folder` 配置，确保文件路径正确

### 4. Session 失效
- **问题**：登录后立即失效
- **解决**：检查 `SECRET_KEY` 是否一致，确保使用 HTTPS

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. 应用日志
2. 服务器日志
3. Nginx 日志（如果使用）
